<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medicare QR Scanner</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
  body {
    margin: 0;
    padding: 0;
    font-family: 'Roboto', sans-serif;
    background: #121212;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  h1 {
    margin-top: 20px;
    font-weight: 700;
  }
  .glass-container {
    background: rgba(255,255,255,0.05);
    border-radius: 15px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    padding: 20px 30px;
    margin: 20px;
    max-width: 500px;
    width: 90%;
  }
  .square-video-container {
    position: relative;
    width: 100%;
    max-width: 350px;
    aspect-ratio: 1 / 1;
    margin: 0 auto;
    border-radius: 12px;
    overflow: hidden;
    background: #000;
  }
  .square-video-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.2);
    background: #000;
    display: block;
  }
  .info-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .field {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.2);
    padding: 10px 12px;
    border-radius: 10px;
    color: #e0e0e0;
    font-size: 16px;
    word-wrap: break-word;
    margin-bottom: 5px;
  }
  .field span.label {
    font-weight: 500;
    color: #fff;
    margin-right: 8px;
    display: inline-block;
    min-width: 90px;
  }
  p {
    text-align: center;
    color: #aaa;
    margin-top: 8px;
    font-size: 14px;
  }
  #switchBtn, #startCameraBtn {
    margin-top: 10px;
    padding: 8px 12px;
    border-radius: 8px;
    border: none;
    background: rgba(255,255,255,0.1);
    color: #fff;
    cursor: pointer;
    font-size: 14px;
    margin-right: 5px;
  }
  #startCameraBtn {
    background: rgba(0,150,255,0.3);
    border: 1px solid rgba(0,150,255,0.5);
  }
  @media (max-width:480px) {
    .glass-container {
      margin: 10px;
      padding: 15px 8px;
    }
    .square-video-container {
      max-width: 280px;
    }
    h1 {
      font-size: 24px;
      margin-top: 15px;
    }
    .field span.label {
      min-width: 70px;
      font-size: 14px;
    }
    .field {
      font-size: 15px;
    }
  }
</style>
</head>
<body>
<h1>Medicare QR Scanner</h1>
<div class="glass-container">
  <div class="square-video-container">
    <video id="video" autoplay playsinline></video>
  </div>
  <p>Point your camera at the patient's QR code</p>
  <button id="switchBtn">Switch Camera</button>
  <button id="startCameraBtn" style="display: none;">Start Camera</button>
</div>
<div class="glass-container info-container" id="patient-info">
  <h2>Patient Info:</h2>
</div>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
const video = document.getElementById('video');
const infoContainer = document.getElementById('patient-info');
const switchBtn = document.getElementById('switchBtn');
const startCameraBtn = document.getElementById('startCameraBtn');

let lastPatientCode = null;
let devices = [];
let currentDeviceIndex = 0;
let isScanning = false;
let currentStream = null;

// Check if device is iOS
function isIOS() {
  return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}

// Stop current camera stream
function stopCurrentStream() {
  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
    currentStream = null;
  }
}

// Parse patient info separated by // and colon
function parsePatientData(data) {
  return data.split('//').map(field => {
    field = field.trim();
    const parts = field.split(':');
    if (parts.length < 2) return null;
    return {
      label: parts[0].trim(),
      value: parts.slice(1).join(':').trim()
    };
  }).filter(f => f !== null);
}

// Display patient info in separate divs
function displayPatientInfo(fields){
  infoContainer.querySelectorAll('.field').forEach(el=>el.remove());
  fields.forEach(f=>{
    const div = document.createElement('div');
    div.className='field';
    div.innerHTML=`<span class="label">${f.label}:</span> ${f.value}`;
    infoContainer.appendChild(div);
  });
  infoContainer.scrollIntoView({behavior:'smooth'});
}

// QR scanning (throttled for performance)
let scanFrameCount = 0;
function scanLoop(){
  if(!isScanning) return;
  scanFrameCount++;
  if(scanFrameCount % 3 === 0 && video.readyState === video.HAVE_ENOUGH_DATA){
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height);
    if(code && code.data!==lastPatientCode){
      lastPatientCode = code.data;
      const fields = parsePatientData(code.data);
      if(fields.length>0) displayPatientInfo(fields);
    }
  }
  requestAnimationFrame(scanLoop);
}

// Start/Stop scanning
function startScanning() {
  isScanning = true;
  scanLoop();
}
function stopScanning() {
  isScanning = false;
}

// Start camera by deviceId with square aspect ratio
async function startCameraByDevice(deviceId, facingMode = null){
  try{
    stopCurrentStream();
    let constraints = {
      video: {
        width: { ideal: 1280 },
        height: { ideal: 1280 },
        aspectRatio: { ideal: 1.0 }
      }
    };
    if (deviceId) {
      constraints.video.deviceId = { exact: deviceId };
    } else if (facingMode) {
      constraints.video.facingMode = { ideal: facingMode };
    }
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    currentStream = stream;
    video.srcObject = stream;
    return true;
  }catch(err){
    console.error("Camera access failed:", err);
    return false;
  }
}

// Get camera devices
async function getCameraDevices() {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    return devices.filter(d => d.kind === 'videoinput');
  } catch (err) {
    console.error("Failed to enumerate devices:", err);
    return [];
  }
}

// Find best camera (prefer back camera)
function findBestCamera(devices) {
  const backCamera = devices.find(d =>
    d.label.toLowerCase().includes('back') ||
    d.label.toLowerCase().includes('rear') ||
    d.label.toLowerCase().includes('environment')
  );
  return backCamera || devices[0] || null;
}

// Show notification
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${type === 'error' ? 'rgba(255,0,0,0.8)' : 'rgba(0,150,255,0.8)'};
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    z-index: 1000;
    font-size: 14px;
    backdrop-filter: blur(10px);
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 3000);
}

// Initialize camera
async function initCamera(){
  try {
    devices = await getCameraDevices();
    if(devices.length === 0) {
      showNotification("No camera found on this device", "error");
      return;
    }
    const bestCamera = findBestCamera(devices);
    currentDeviceIndex = devices.indexOf(bestCamera);
    const success = await startCameraByDevice(bestCamera.deviceId);
    if (!success) {
      const fallbackSuccess = await startCameraByDevice(null, 'environment');
      if (!fallbackSuccess) {
        const frontSuccess = await startCameraByDevice(null, 'user');
        if (frontSuccess) {
          showNotification("Using front camera - flip device for better QR scanning", "info");
        } else {
          showNotification("Camera access failed - please check permissions", "error");
          return;
        }
      }
    }
    switchBtn.style.display = devices.length > 1 ? "inline-block" : "none";
    startScanning();
  } catch (err) {
    showNotification("Could not access camera. Try again.", "error");
    startCameraBtn.style.display = "inline-block";
  }
}

// Switch camera
async function switchCamera(){
  if(devices.length < 2) return;
  currentDeviceIndex = (currentDeviceIndex + 1) % devices.length;
  let nextDevice = devices[currentDeviceIndex];
  const success = await startCameraByDevice(nextDevice.deviceId);
  if (success) {
    showNotification("Switched camera", "info");
  } else {
    showNotification("Unable to switch camera", "error");
  }
}

// On page load, request camera access
window.addEventListener('DOMContentLoaded', async () => {
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    await initCamera();
  } else {
    showNotification("Camera not supported in this browser", "error");
  }
});

// Handle start camera button
startCameraBtn.addEventListener('click', async () => {
  startCameraBtn.style.display = "none";
  await initCamera();
});

// Handle camera switching
switchBtn.addEventListener('click', async () => {
  await switchCamera();
});

// Stop camera when navigating away
window.addEventListener('beforeunload', () => {
  stopCurrentStream();
  stopScanning();
});
</script>
</body>
</html>
